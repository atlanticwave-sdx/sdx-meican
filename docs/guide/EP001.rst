:EP: 1
:Title: CILogon Implementation
:Authors:
    - Usman Aziz
    - Mahidhar
:Reviewers: to be defined
:Created: to be defined
:Meican-Version: to be defined
:Status: Draft
:Type: Standards Track

******************************
EP001 - CILogon Implementation
******************************

########
Abstract
########
The focus of this blueprint is solely on integrating CILogon with Meican and implementing the associated security measures, such as token generation, storage, and expiration management within Meican authentication subsystem.

##########
Motivation
##########
The integration of CILogon with Meican serves a primary objective: to streamline authentication processes by enabling Federated Authentication. This means users of Meican can seamlessly access the system using their existing credentials from their respective organizations, eliminating the need to create new (username/password) accounts. Moreover, this integration offers the added advantage of leveraging CILogon's robust multi-factor authentication capabilities, thereby fortifying security measures. By emphasizing the core goal of Federated Authentication and highlighting the supplementary benefit of two-factor authentication, Meican ensures heightened security and user convenience.

#######################################################
Requirements for Integration between Meican and CILogon
#######################################################

- **Configuration Management:** To enable or disable the CILogon page within the Meican application, we have implemented a straightforward approach using environment variables.

  - **Implementation:** Within the `index.php` file, we have introduced a new environment variable named 'ENABLE_CILOGON_PAGE' for         managing the visibility of the CILogon page.
  - **Usage:** By simply commenting out or uncommenting the line defining this environment variable, administrators can control            whether the CILogon page is accessible to users.
  - **Example:**
    - To enable the CILogon page: Uncomment the line `defined('ENABLE_CILOGON_PAGE') or define('ENABLE_CILOGON_PAGE', true);` in the         `index.php` file.
    - To disable the CILogon page: Comment out the line `defined('ENABLE_CILOGON_PAGE') or define('ENABLE_CILOGON_PAGE', true);` in          the `index.php` file.
This approach offers a simple and effective means of configuring the availability of the CILogon authentication option, providing administrators with flexibility in managing authentication settings within the Meican application.

- **User Interface:** choose between CILogon authentication and Meican's local authentication database.
- **Secure Storage:** 
- **Troubleshooting:**


#####################################
Concepts of Federated Authentication:
#####################################

Federated authentication is a mechanism that allows users to access multiple services or applications using their credentials from a trusted identity provider (IdP). This approach offers several benefits, including enhanced user convenience, simplified access management, and improved security.

1. **Identity Providers (IdP):**
   Identity providers are trusted entities responsible for authenticating users and providing them with access to various services and applications. IdPs verify user identities based on their established credentials, such as usernames and passwords, and issue authentication tokens or assertions to grant access to service providers.

2. **Service Providers (SP):**
   Service providers are entities that offer services or applications to users. SPs rely on identity providers for user authentication and authorization. Once a user is authenticated by the IdP, the SP grants access to the requested service or application based on the provided authentication token or assertion.

3. **Federations:**
   Federations are collaborative networks of organizations that establish trust relationships to enable federated authentication. Federations define standards and protocols for identity and attribute exchange, allowing users from member organizations to access services seamlessly across the federation. This approach promotes interoperability and facilitates secure access to resources across organizational boundaries.

4. **Examples of Federations:**
   - **CILogon:** CILogon is a federated identity management service specifically designed for the research and education community. It provides a secure and streamlined authentication process, allowing users to access a wide range of research and collaboration services using their existing credentials from participating organizations.
   - **EduGain:** EduGain is a global interfederation service that enables identity federation among academic and research institutions worldwide. It promotes collaboration and resource sharing by allowing users to access educational resources and services across international boundaries using their institutional credentials.

By leveraging federated authentication like **CILogon** in our case, enhances user access management, improves collaboration, and strengthens security overall.

#########
Rationale
#########

Justification for Design Choices
--------------------------------
   - **Enhanced Security**: Integration of CILogon enhances security beyond traditional logins, mitigating risks like password theft and unauthorized access.
   - **User Experience**: Prioritizing user experience, a balance between security and convenience was achieved by allowing access without frequent authentication prompts within a two-day window.

Consideration of Alternatives
------------------------------
   - **Authentication Methods**: During the evaluation process, various authentication methods were considered, including OAuth-based solutions. However, after careful assessment, CILogon emerged as the preferred choice due to its specialized focus on the research and education community, robust security features, and seamless integration capabilities. Unlike other third-party authenticators, CILogon offers specialized expertise, community trust, enhanced security features like multi-factor authentication, and interoperability with industry standards, making it the optimal authentication solution for Meican.
   - **Token Expiration**: While dynamic expiration was contemplated, a fixed two-day expiration period was chosen for simplicity and security, ensuring that tokens remain valid for an adequate duration without compromising security.
   
Related Work and Industry Standards
------------------------------------
   - **CILogon Integration**: Aligns with established standards in academic and research communities, ensuring compatibility and interoperability with existing infrastructure.
   - **Token-Based Authentication**: Meican's adoption of token-based authentication follows industry-standard practices, ensuring scalability and interoperability with other systems.

Consideration of Future Scalability and Maintainability
--------------------------------------------------------
   - **Modular Design**: Implementation of a dedicated table (meican_cilogon_auth) ensures scalability and ease of integration with future updates and enhancements.
   - **Token Workflow**: Automated token generation and expiration updates minimize maintenance overhead, ensuring efficient management of authentication tokens over time.



#############
Specification
#############

**The Idea:**

.. image:: /docs/CILogonFlow.png
   :alt: Alternative Text

**Specification:**

1. **CILogon Integration:** Integrate CILogon authentication with Meican's topology mapping system [1].
2. **Database Table Creation:** Create a new table named "meican_cilogon_auth" to store essential data such as user tokens, expiration dates, and user IDs.
3. **Token Generation and Insertion:** Upon successful login with CILogon, generate a new token with a two-day expiration period and insert it into the "meican_cilogon_auth" table.
4. **Access Management:** Allow users to access Meican without prompting for CILogon login if they login within the two-day validity period of the token.
5. **Expiration Handling:** If a user attempts to log in after the token expiration period (two days), prompt for CILogon login again. Next, update the token and expiration date in the "meican_cilogon_auth" table accordingly.
6. **Migration File Creation:** Created a migration file for the "meican_cilogon_auth" table.
7. **Removing CILogon for Master User:** We made sure that CI-Logon will not get prompted for the master user explicitly, and similarly we can do the same for any other criteria based on the requirements.

**Token Expiration Workflow:**

1. When a user logs in with CILogon, the system generates a new token and stores it in the "meican_cilogon_auth" table, along with the user's ID and an expiration date set to two days from the current timestamp.
2. If the same user logs in within the two-day window, they won't be prompted for CILogon authentication again.
3. However, if the user attempts to log in after the expiration period (two days), the system will require them to go through the CILogon authentication process again.


This comprehensive approach ensures the CILogon integration with Meican effectively while managing token expiration and user authentication seamlessly.

#######################
CILogon Workflow
#######################

The below image shows the actual Authentication process workflow.

.. image:: /docs/ActualCILogonFlow.png
   :alt: Alternative Text

#######################
Backward Compatibility
#######################
Not applicable here

#####################
Security Implications
#####################
In the event of a data breach on the Identity Provider (CILogon), Meican takes proactive measures to mitigate potential risks:

1. **Non-collection of Personal Information:**
   Meican prioritizes user privacy by refraining from collecting personal information. This practice minimizes the impact of external breaches on user data integrity.
2. **Implementation of Security Measures:**
   Meican implements robust security measures to safeguard user accounts and data by adhering to industry standards. Theis ensure robust protection of user data against unauthorized access and breaches.
3. **Preventive Suspension of Compromised Accounts:**
   Upon identification of a compromised account, Meican promptly suspends the account to prevent further unauthorized activity. This proactive measure helps safeguard the Meican platform and its users from potential security threats arising from compromised accounts.

##############
Rejected Ideas
##############
Not applicable here

##########
References
##########
[1] https://www.cilogon.org/oidc

#########
Copyright
#########
Copyright (c) 2012-2021 by RNP(http://www.rnp.br).
All rights reserved. MEICAN is released under the BSD2 License. For more information see LICENSE(https://github.com/ufrgs-hyman/meican/blob/master/LICENSE.md).
